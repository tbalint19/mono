# DATABASE

## Start DB

```bash
# monorepo/executables/database
docker-compose up -d

# check logs - optional
 docker-compose logs -f
```

## Connect database admin tool (PgAdmin) - optional

- Go to [localhost:8080](http://localhost:8080)
- Login with credentials set in .env
  - email: .env -> **DATABASE_ADMIN_EMAIL**
  - password: -env -> **DATABASE_ADMIN_PASSWORD**
- Connect database: Servers (top left) -> Register -> Server
  - General/Name: can be anything, only display name in PgAdmin
  - Connection/Host name: **db** (from docker-compose.yml - related _key_ in services)
  - Connection/Port: **5432** (keep default - set in docker-compose.yml)
  - Maintenance database: **postgres** (keep default - used for server maintenance tasks)
  - Username: .env -> **DATABASE_USER**
  - Password: .env -> **DATABASE_PASSWORD**
  - **Keep other fields and tabs unchanged**
- Server with name set in General/Name will appear
- Open it -> Databases(2)
  - postgres (maintenance database - not interesting)
  - .env -> **DATABASE_NAME** -> Schemas -> public -> Tables (empty by default)

## Create migrations

- Update table definitions in _monorepo/domain/models/src/schemas/tables.ts_
- Generate SQL migrations based on changes

```bash
# monorepo/executables/database
npm run generate
# will create sql folder and/or update its content
```

- OR create data migrations

```bash
# monorepo/executables/database
npm run generate -- --custom
# will create sql folder and/or update its content
# --> ADD SQL INSERTS to generated sql file
```

## Run migrations

- Run migrations (will only run _new_ ones - will track them in autogenerated metadata schema)

```bash
# monorepo/executables/database
npm run migrate
# check __drizzle_migrations metadata table in drizzle schema
```

## Manage database

- Update schema defintions
- Run migration
- Use PgAdmin to check tables / metadata table
- Repeat...

## Stop database

```bash
# monorepo/executables/database
docker-compose down
# will keep volume (and thus, all added tables and data)

# or
 docker-compose down -v
 # stop database AND DELETE ALL TABLES AND DATA
```
